@model ProgettoIUM.Web.Features.Compilazione.CompilazioneViewModel
@{
    ViewData["Title"] = "Compilazione";
}

<div class="container py-5">
    <div class="d-flex align-items-center mb-4">
        <h1 class="fw-bold h2">Compilazione Segnalazione</h1>
        <a href="/" class="ms-auto btn btn-light rounded-circle shadow-sm">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
    </div>

    <div class="card border-0 shadow-lg rounded-4 p-5" style="background-color: #f2f2f2;">
        <form asp-controller="Compilazione" asp-action="Conferma" method="post" enctype="multipart/form-data">

            <h5 class="text-center fw-bold mb-4 mt-2">INFORMAZIONI</h5>

            <div class="row g-4 mb-5">
                <div class="col-md-6">
                    <label class="small fw-bold mb-2">Categoria Illecito</label>
                    <select asp-for="Categoria" class="form-select border-0 shadow-sm py-2 px-3">
                        <option value="">Seleziona...</option>
                        @foreach (var cat in Model.CategorieDisponibili)
                        {
                            <option value="@cat">@cat</option>
                        }
                    </select>
                    <span asp-validation-for="Categoria" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold mb-2">Data e Ora</label>
                    <input asp-for="DataInvio"
                           type="datetime-local"
                           class="form-control border-0 shadow-sm py-2"
                           value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")"
                           readonly
                           style="background-color: #e9ecef !important;" />
                    <span asp-validation-for="DataInvio" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label class="small fw-bold mb-2">Luogo</label>
                    <input type="text" asp-for="Luogo" class="form-control border-0 shadow-sm py-2" />
                    <span asp-validation-for="Luogo" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold mb-2">Reparto</label>
                    <input type="text" asp-for="Reparto" class="form-control border-0 shadow-sm py-2" />
                    <span asp-validation-for="Reparto" class="text-danger"></span>
                </div>
            </div>

            <h5 class="text-center fw-bold mb-3">DESCRIZIONE ACCADUTO</h5>
            <div class="mb-5">
                <textarea asp-for="Descrizione" rows="6" class="form-control border-0 shadow-sm p-3"></textarea>
                <span asp-validation-for="Descrizione" class="text-danger"></span>
            </div>

            <h5 class="text-center fw-bold mb-3">DOCUMENTAZIONE</h5>
            <div class="upload-area border border-2 border-dashed rounded-4 p-5 text-center mb-5 bg-white"
                 style="border-style: dashed !important; border-color: #dee2e6 !important;">

                <i class="fa-solid fa-cloud-arrow-up fa-3x mb-3 text-muted"></i>
                <h1></h1>

                <input type="file" asp-for="Allegato" class="d-none" id="fileInput" />
                <input type="hidden" asp-for="NomeFileGiaCaricato" />
                <input type="hidden" asp-for="PathFileGiaCaricato" />

                <button type="button" class="btn btn-outline-primary rounded-pill px-4 fw-bold"
                        onclick="document.getElementById('fileInput').click()"
                        style="border-color: #618ccf; color: #618ccf;">
                    SELEZIONA UN FILE
                </button>

                <div id="fileName" class="mt-3 small fw-bold text-primary">
                    @if (!string.IsNullOrEmpty(Model.NomeFileGiaCaricato))
                    {
                        <text>
                            <i class="fa-solid fa-file me-2"></i>
                            File caricato: @Model.NomeFileGiaCaricato
                        </text>
                    }
                </div>

                <span asp-validation-for="Allegato" class="text-danger"></span>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-lg px-5 py-3 shadow-sm fw-bold text-white"
                        style="border-radius: 12px; background-color: #618ccf; border: none; min-width: 300px;">
                    CONFERMA SEGNALAZIONE
                </button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="leaveModal" tabindex="-1" aria-labelledby="leaveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="leaveModalLabel">Attenzione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Se esci dalla pagina perderai i dati inseriti.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Rimani</button>
                <button type="button" class="btn btn-primary rounded-pill" id="confirmLeave">Esci comunque</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        var fileInput = document.getElementById('fileInput');
        var fileDiv = document.getElementById('fileName');

        fileInput.onchange = function () {
            var fileName = this.files[0] ? this.files[0].name : "";

            if (fileName) {
                // Nuovo file selezionato
                fileDiv.innerHTML = "<i class='fa-solid fa-file-clip me-2'></i> Nuovo file: " + fileName;
            } else {
                // Nessun file selezionato: mostra eventualmente il file già caricato
                fileDiv.innerHTML = '@Html.Raw(!string.IsNullOrEmpty(Model.NomeFileGiaCaricato)
                                                                                    ? "<i class=\\'fa-solid fa-file me-2\\'></i> File caricato: " + Model.NomeFileGiaCaricato
                                                                                    : "")';
        }
    };

        var formSubmitting = false;

        document.querySelector("form").addEventListener("submit", function () {
            formSubmitting = true;
        });

        document.querySelector("a[href='/']").addEventListener("click", function (e) {
            e.preventDefault();
            var leaveModal = new bootstrap.Modal(document.getElementById('leaveModal'));
            leaveModal.show();

            document.getElementById('confirmLeave').onclick = function () {
                window.location.href = "/";
            };
        });

        window.addEventListener("beforeunload", function (e) {
            if (!formSubmitting) {
                e.preventDefault();
                e.returnValue = "";
            }
        });
    </script>
}

<style>
    html, body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
    }

    body {
        background: linear-gradient(180deg, #FFFFFF 0%, #ECECEC 91%);
        background-attachment: fixed;
        background-repeat: no-repeat;
    }
</style>
