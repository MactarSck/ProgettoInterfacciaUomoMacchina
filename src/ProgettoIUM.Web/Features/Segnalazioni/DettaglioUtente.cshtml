@model ProgettoIUM.Web.Features.Segnalazioni.EditViewModel

@{
    Layout = "_LayoutUser";
}

@section pageTitle {
    @{
        ViewData["Title"] = "Segnalazione - #" + Model.Id.ToString().Substring(0, 8).ToUpper();
    }

    <nav class="navbar navbar-expand navbar-light px-4">
        <div class="navbar-brand fw-bold text-uppercase" style="letter-spacing: 1px;">
            @ViewData["Title"]
        </div>

  

    </nav>

    <hr class="mt-0" style="height: 3px; opacity: 1;">
}


<div id="vue-app" class="container-lg py-3">
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm rounded-4 mb-4" role="alert">
            <i class="fa-solid fa-triangle-exclamation me-2"></i>
            @TempData["ErrorMessage"]

            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm rounded-4 mb-4" role="alert">
            <i class="fa-solid fa-circle-check me-2"></i>
            @TempData["SuccessMessage"]

            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @* --- INTESTAZIONE E STATO --- *@
    <div class="text-center mb-5">
        <p class="text-muted small text-uppercase fw-bold mb-2" style="letter-spacing: 1px;">Stato attuale della pratica</p>

                    @{
            string stato = Model.StatoAttuale?.ToLower() ?? "aperto";
            string bgColor = "#fff9db";
            string textColor = "#856404";
            string dotColor = "#f59e0b";

            if (stato == "chiusa" || stato == "chiuso")
            {
                bgColor = "#d1e7dd";
                textColor = "#0f5132";
                dotColor = "#198754";
            }
            else if (stato == "nuova - in attesa di verifica")
            {
                bgColor = "#cfe2ff";
                textColor = "#084298";
                dotColor = "#0d6efd";
            }
            else if (stato == "aperto" || stato == "inviata")
            {
                bgColor = "#cfe2ff";
                textColor = "#084298";
                dotColor = "#0d6efd";
            }


            
        }

        <div class="d-inline-flex align-items-center rounded-pill shadow-sm p-3 px-5 border-0"
             style="background-color: @bgColor; color: @textColor; letter-spacing: 1px;">
            <span class="rounded-circle me-2" style="width: 10px; height: 10px; background-color: @dotColor;"></span>
            <span class="fw-bold text-uppercase">@Model.StatoAttuale</span>
        </div>

        
        <div class="mt-3">
            <button onclick="window.location.reload();" class="btn btn-link btn-sm text-decoration-none text-black p-2" title="Verifica se ci sono nuovi aggiornamenti dall'operatore">
                <i class="fa-solid fa-arrows-rotate me-1"></i> Sincronizza dati
            </button>
        </div>
    </div>

    @* --- AREA ESITO FINALE (Highlight se presente) --- *@
    @if (!string.IsNullOrWhiteSpace(Model.Esito))
    {
        <div class="mx-auto mb-5 p-4 rounded-4 border border-success bg-success bg-opacity-10 shadow-sm" style="max-width: 750px;">
            <div class="d-flex align-items-center mb-2">
                <i class="fa-solid fa-check-circle text-success fs-4 me-2"></i>
                <h6 class="fw-bold text-success text-uppercase m-0" style="letter-spacing: 1px;">Conclusione della segnalazione</h6>
            </div>
            <p class="mb-0 text-dark" style="line-height: 1.6;">@Model.Esito</p>
            <hr class="text-success opacity-25">
            <small class="text-muted fst-italic">Questa nota rappresenta la valutazione definitiva del team addetto alla sicurezza.</small>
        </div>
    }

    <hr class="mt-0" style="height: 3px; opacity: 1;">


    @* --- TIMELINE/INFO TEMPORALI --- *@
    <div class="row justify-content-center mb-5">
        <div class="col-auto">
            <div class="bg-white rounded-pill shadow-sm border px-4 py-2 d-flex align-items-center gap-3">
                <div class="text-center border-end pe-3">
                    <small class="text-muted d-block text-uppercase" style="font-size: 0.65rem;">Data Invio</small>
                    <span class="fw-bold small">@Model.DataInvio.ToString("dd/MM/yyyy")</span>
                </div>
                <div class="text-center">
                    <small class="text-muted d-block text-uppercase" style="font-size: 0.65rem;">Risoluzione Prevista</small>
                    <span class="fw-bold small text-primary">@(Model.DataRisoluzionePrevista?.ToString("dd/MM/yyyy") ?? "TBD")</span>
                </div>
            </div>
        </div>
    </div>
   
    <div class="d-flex flex-column align-items-center justify-content-center my-5">
         <div id="chatText" class="mt-3 text-danger fw-bold" style="display: none; font-size: 0.95rem;">
            <i class="fa-solid fa-circle-exclamation text-danger"></i> Nuovi messaggi da leggere
        </div>
        <div class="position-relative d-inline-block">
            <button id="btnChat" class="btn btn-primary btn-lg px-5 py-3 shadow  fw-bold"
                    type="button" data-bs-toggle="offcanvas" data-bs-target="#chatOffcanvas" aria-controls="chatOffcanvas">
                <i class="fa-solid fa-comments me-2"></i>Chat con il Gestore
            </button>

            <span id="chatBadge" class="position-absolute top-0 start-100 translate-middle badge  "
                  style="display: none; width: 15px; height: 15px; padding: 0; margin-top: 5px; margin-left: -5px;">
            </span>
        </div>

       
    </div>

    @* --- SEZIONE STORICO STATI --- *@
    <div class="custom-gray-card mb-5">
        <h5 class="text-center fw-bold text-uppercase mb-4 pt-2" style="letter-spacing: 2px;">
            TIMELINE SEGNALAZIONE
        </h5>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="fw-semibold text-muted small">
                @Model.StoricoStati.Count() stati totali
            </span>

        </div>

        <div class="timeline-card p-4">
            @if (Model.StoricoStati != null && Model.StoricoStati.Any())
            {
                <div class="timeline">
                    @foreach (var s in Model.StoricoStati)
                    {
                        <div class="timeline-item">
                            <div class="timeline-icon">
                                <i class="fa-solid fa-circle"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-time">
                                    @s.DataCambio.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                </div>
                                <div class="timeline-state">@s.StatoNuovo</div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="text-center mb-0">Nessuno storico disponibile.</p>
            }
        </div>
    </div>


   

    <style>
        
        .btn-chat-pulse {
            animation: shadow-pulse 2s infinite;
        }

        @@keyframes shadow-pulse {
            0% {
                box-shadow: 0 0 0 0px rgba(220, 53, 69, 0.4);
            }

            100% {
                box-shadow: 0 0 0 15px rgba(220, 53, 69, 0);
            }
        }
    </style>


    <div class="offcanvas offcanvas-end" tabindex="-1" id="chatOffcanvas" aria-labelledby="chatOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="chatOffcanvasLabel">Comunicazioni con il Gestore</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Chiudi"></button>
        </div>

        <div class="offcanvas-body d-flex flex-column p-0">

            <div id="chat-box" class="flex-grow-1 overflow-auto p-3 bg-light" style="min-height: 200px; max-height: 80vh;">
                @if (Model.ChatMessaggi != null && Model.ChatMessaggi.Any())
                {
                    DateTime? lastDay = null;

                    foreach (var c in Model.ChatMessaggi.OrderBy(m => m.DataInvio))
                    {
                        var messageDay = c.DataInvio.Date;

                        if (lastDay == null || lastDay.Value != messageDay)
                        {
                            <div class="text-center my-2">
                                <small class="fw-bold text-secondary bg-white px-3 py-1 rounded">
                                    @messageDay.ToString("dddd dd MMMM yyyy")
                                </small>
                            </div>
                            lastDay = messageDay;
                        }

                        <div class="mb-3 d-flex @(c.IsOperatore ? "justify-content-start" : "justify-content-end")"
                             style="flex-direction: column; align-items: @(c.IsOperatore ? "flex-start" : "flex-end");">

                            <div style="max-width: 70%;">
                                @if (c.IsOperatore)
                                {
                                    <small class="fw-bold text-secondary d-block mb-1">Gestore</small>
                                }
                                <div class="p-2 rounded-3 @(c.IsOperatore ? "bg-light text-dark border border-secondary" : "bg-primary text-white border border-secondary")">
                                    <span>@c.Testo</span>
                                </div>
                                <small class="text-muted mt-1" style="font-size: 0.7rem;">
                                    @c.DataInvio.ToLocalTime().ToString("HH:mm")
                                </small>
                            </div>

                        </div>
                    }
                }
                else
                {
                    <p class="text-muted text-center mb-0">Non ci sono ancora messaggi in questa conversazione.</p>
                }
            </div>
   
            <form method="post" asp-action="AddMessageUtente" asp-controller="Home" class="d-flex p-3 border-top" id="chatForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="segnalazioneId" value="@Model.Id" />
                <input type="text" name="testo" id="chat-testo" class="form-control me-2" placeholder="Scrivi un messaggio..." style="max-width: 70%;" required />
                <button type="submit" class="btn btn-primary">Invia</button>
            </form>


        </div>
    </div>
         <h1></h1>

    @* --- DATI SEGNALAZIONE (DETTAGLIO) --- *@
    <div class="custom-gray-card shadow-lg p-5 rounded-5 mx-auto mb-5" style="max-width: 900px; background-color: #fcfcfc; border: 1px solid #eee;">
        <div class="text-center mb-5">
            <h5 class="fw-bold text-uppercase m-0" style="letter-spacing: 2px;">Riepilogo Segnalazione</h5>
            <div class="bg-primary mx-auto mt-2" style="width: 50px; height: 3px; border-radius: 2px;"></div>
        </div>

        <div class="row gy-4 px-lg-4">
            <div class="col-md-6">
                <label class="text-muted small text-uppercase fw-bold d-block mb-1">Tipologia</label>
                <div class="p-3 bg-white border rounded-3 shadow-sm">
                    <i class="fa-solid fa-tag text-primary me-2"></i> @Model.Categoria
                </div>
            </div>
            <div class="col-md-6">
                <label class="text-muted small text-uppercase fw-bold d-block mb-1">Luogo e Reparto</label>
                <div class="p-3 bg-white border rounded-3 shadow-sm">
                    <i class="fa-solid fa-location-dot text-danger me-2"></i> @Model.Luogo @(string.IsNullOrEmpty(Model.Reparto) ? "" : $" - {Model.Reparto}")
                </div>
            </div>

            <div class="col-12">
                <label class="text-muted small text-uppercase fw-bold d-block mb-1">Documentazione Allegata</label>
                <div class="p-3 bg-white border rounded-3 shadow-sm">
                    @if (!string.IsNullOrEmpty(Model.PathFile))
                    {
                        <div class="d-flex align-items-center justify-content-between">
                            <span><i class="fa-solid fa-file-pdf text-danger me-2"></i> @Model.</span>
                            <a href="@Model.PathFile" target="_blank" class="btn btn-sm btn-primary rounded-pill px-4">
                                <i class="fa-solid fa-download me-1"></i> Scarica
                            </a>
                        </div>
                    }
                    else
                    {
                        <span class="text-muted small"><i class="fa-solid fa-circle-info me-2"></i>Nessun file caricato per questa segnalazione.</span>
                    }
                </div>
            </div>

            <div class="col-12 mt-4">
                <label class="text-muted small text-uppercase fw-bold d-block mb-1">Testo della segnalazione</label>
                <div class="p-4 bg-white border rounded-4 shadow-sm text-muted" style="line-height: 1.8; border-left: 4px solid #0d6efd !important;">
                    @Model.Descrizione
                </div>
            </div>
        </div>
    </div>
</div>

<style>

    html, body {
        margin: 0;
        padding: 0;
      
        min-height: 100vh;
    }

    body {
        
        background: linear-gradient(180deg, #FFFFFF 0%, #ECECEC 91%);
        
        background-attachment: fixed;
        background-repeat: no-repeat;
    }

    .timeline {
        .timeline-card {
            background: #ffffff;
            border-radius: 18px;
            border: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 12px 30px rgba(0,0,0,0.08);
            max-width: 900px;
            margin: 0 auto;
        }

        .timeline {
            position: relative;
            margin: 0;
            padding-left: 30px;
        }

            .timeline::before {
                content: "";
                position: absolute;
                left: 18px;
                top: 0;
                bottom: 0;
                width: 2px;
                background: linear-gradient(180deg, rgba(13,110,253,0.9), rgba(13,110,253,0.3));
                border-radius: 999px;
            }

        .timeline-item {
            position: relative;
            margin-bottom: 18px;
            padding-left: 18px;
        }

        .timeline-icon {
            position: absolute;
            left: -2px;
            top: 0;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255,255,255,0.85);
            border: 2px solid rgba(13,110,253,0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 18px rgba(0,0,0,0.07);
            backdrop-filter: blur(6px);
        }

            .timeline-icon i {
                font-size: 10px;
                color: #0d6efd;
            }

        .timeline-content {
            padding: 10px 12px;
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.06);
            box-shadow: 0 8px 18px rgba(0,0,0,0.07);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

            .timeline-content:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            }

        .timeline-time {
            font-size: 0.78rem;
            color: #6c757d;
        }

        .timeline-state {
            font-weight: 700;
            font-size: 0.95rem;
            margin-top: 3px;
            letter-spacing: 0.2px;
        }
    }

</style>



<script>
    history.pushState(null, null, location.href);
    window.onpopstate = function () {
        location.replace('/Home/Index');
    };
</script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var offcanvasElement = document.getElementById('chatOffcanvas');

        offcanvasElement.addEventListener('shown.bs.offcanvas', function () {
            var chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '<p class="text-center text-muted">Caricamento...</p>';

            var segnalazioneId = "@Model.Id"; 

            fetch(`/Home/GetMessaggi?segnalazioneId=${segnalazioneId}`)
                .then(response => response.json())
                .then(data => {
                    chatBox.innerHTML = '';
                    var lastDay = null;

                    data.forEach(m => {
                        if (lastDay !== m.giorno) {
                            var giornoDiv = document.createElement('div');
                            giornoDiv.className = 'text-center my-2';
                            giornoDiv.innerHTML = `<small class="fw-bold text-secondary bg-white px-3 py-1 rounded">${m.giorno}</small>`;
                            chatBox.appendChild(giornoDiv);
                            lastDay = m.giorno;
                        }

                        var container = document.createElement('div');
                        container.className = 'mb-3 d-flex';
                        container.style.flexDirection = 'column';
                        container.style.alignItems = m.isOperatore ? 'flex-start' : 'flex-end';

                        var msgDiv = document.createElement('div');
                        msgDiv.style.maxWidth = '70%';

                        if (m.isOperatore) {
                            msgDiv.innerHTML += `<small class="fw-bold text-secondary d-block mb-1">Gestore</small>`;
                        }

                        msgDiv.innerHTML += `<div class="p-2 rounded-3 ${m.isOperatore ? 'bg-light text-dark border border-secondary' : 'bg-primary text-white border border-secondary'}">
                                                <span>${m.testo}</span>
                                             </div>
                                             <small class="text-muted mt-1" style="font-size:0.7rem">${m.data}</small>`;

                        container.appendChild(msgDiv);
                        chatBox.appendChild(container);
                    });
                })
                .catch(err => {
                    chatBox.innerHTML = '<p class="text-center text-danger">Errore nel caricamento messaggi</p>';
                });
        });
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var offcanvasElement = document.getElementById('chatOffcanvas');

        offcanvasElement.addEventListener('shown.bs.offcanvas', function () {
            var chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '<p class="text-center text-muted">Caricamento...</p>';

            var segnalazioneId = "@Model.Id"; 

            fetch(`/Home/GetMessaggi?segnalazioneId=${segnalazioneId}`)
                .then(response => response.json())
                .then(data => {
                    chatBox.innerHTML = '';
                    var lastDay = null;

                    data.forEach(m => {
                        if (lastDay !== m.giorno) {
                            var giornoDiv = document.createElement('div');
                            giornoDiv.className = 'text-center my-2';
                            giornoDiv.innerHTML = `<small class="fw-bold text-secondary bg-white px-3 py-1 rounded">${m.giorno}</small>`;
                            chatBox.appendChild(giornoDiv);
                            lastDay = m.giorno;
                        }

                        var container = document.createElement('div');
                        container.className = 'mb-3 d-flex';
                        container.style.flexDirection = 'column';
                        container.style.alignItems = m.isOperatore ? 'flex-start' : 'flex-end';

                        var msgDiv = document.createElement('div');
                        msgDiv.style.maxWidth = '70%';

                        if (m.isOperatore) {
                            msgDiv.innerHTML += `<small class="fw-bold text-secondary d-block mb-1">Gestore</small>`;
                        }

                        msgDiv.innerHTML += `<div class="p-2 rounded-3 ${m.isOperatore ? 'bg-light text-dark border border-secondary' : 'bg-primary text-white border border-secondary'}">
                                                <span>${m.testo}</span>
                                             </div>
                                             <small class="text-muted mt-1" style="font-size:0.7rem">${m.data}</small>`;

                        container.appendChild(msgDiv);
                        chatBox.appendChild(container);
                    });
                })
                .catch(err => {
                    chatBox.innerHTML = '<p class="text-center text-danger">Errore nel caricamento messaggi</p>';
                });
        });
    });
</script>


<script>
    document.addEventListener("DOMContentLoaded", function() {

        if (sessionStorage.getItem('apriChat') === 'true') {
            var offcanvasElement = document.getElementById('chatOffcanvas');
            var bsOffcanvas = new bootstrap.Offcanvas(offcanvasElement);
            bsOffcanvas.show();


            sessionStorage.removeItem('apriChat');
        }


        var chatForm = document.getElementById('chatForm');
        if (chatForm) {
            chatForm.addEventListener('submit', function() {
                sessionStorage.setItem('apriChat', 'true');
            });
        }

    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var chatBadge = document.getElementById('chatBadge');
        var btnChat = document.getElementById('btnChat');
        var segnalazioneId = "@Model.Id";

        if (!chatBadge) return;

       
        function checkNewMessages() {
            fetch(`/Home/GetMessaggi?segnalazioneId=${segnalazioneId}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        chatBadge.style.display = 'inline-block';
                    } else {
                        chatBadge.style.display = 'none';
                    }
                })
                .catch(err => console.error(err));
        }


        checkNewMessages();

  
        setInterval(checkNewMessages, 30000); 


        var offcanvasElement = document.getElementById('chatOffcanvas');
        if (offcanvasElement) {
            offcanvasElement.addEventListener('shown.bs.offcanvas', function () {
                chatBadge.style.display = 'none';
            });
        }
    });
</script>
<script>
       document.addEventListener("DOMContentLoaded", function() {
        var chatBadge = document.getElementById('chatBadge');
        var chatText = document.getElementById('chatText');
        var offcanvasElement = document.getElementById('chatOffcanvas');
        var segnalazioneId = "@Model.Id";

        if (!chatBadge || !chatText) return;

        function checkNewMessages() {
            var isChatOpen = offcanvasElement && offcanvasElement.classList.contains('show');

            fetch(`/Home/GetMessaggi?segnalazioneId=${segnalazioneId}`)
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        var lastSeenCount = parseInt(localStorage.getItem('lastSeenMsgs_' + segnalazioneId) || 0);
                        var currentCount = data.length;

                        if (isChatOpen) {
                            localStorage.setItem('lastSeenMsgs_' + segnalazioneId, currentCount);
                            chatBadge.style.display = 'none';
                            chatText.style.display = 'none';
                        }
                        else if (currentCount > lastSeenCount) {
                            chatBadge.style.display = 'inline-block';
                            chatText.style.display = 'block';
                        } else {
                            chatBadge.style.display = 'none';
                            chatText.style.display = 'none';
                        }

                        offcanvasElement.dataset.currentCount = currentCount;
                    }
                })
                .catch(err => console.error(err));
        }

        checkNewMessages();

        if (offcanvasElement) {
            offcanvasElement.addEventListener('shown.bs.offcanvas', function () {
                chatBadge.style.display = 'none';
                chatText.style.display = 'none';
                var currentCount = offcanvasElement.dataset.currentCount || 0;
                localStorage.setItem('lastSeenMsgs_' + segnalazioneId, currentCount);
            });
        }
    });
</script>





