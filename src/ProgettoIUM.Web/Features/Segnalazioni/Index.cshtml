@inject IHtmlLocalizer<ProgettoIUM.Web.Features.Segnalazioni.IndexViewModel> ModelLocalizer
@model ProgettoIUM.Web.Features.Segnalazioni.IndexViewModel

@{
    ViewData["Title"] = "Dashboard Operatori";
}

<div class="container-fluid px-5 mt-4">
    <h2 class="fw-bold pb-0 mb-2">DASHBOARD</h2>

    <hr class="mt-0" style="height: 3px; opacity: 1;">

    <div class="mb-5">
        <form asp-action="Index" method="get" id="searchForm" class="mb-4">
            <div class="row align-items-end g-3 mb-3">
                <div class="col-md-4">
                    <label asp-for="Filter" class="small fw-bold text-muted mb-1">Cerca (Parola chiave)</label>
                    <div class="input-group input-group-sm shadow-sm">
                        <span class="input-group-text bg-white border-end-0 rounded-start">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </span>
                        <input asp-for="Filter" class="form-control form-control-sm border-start-0 rounded-end" placeholder="Categoria, Luogo..." />
                    </div>
                </div>

                <div class="col-md-3">
                    <label asp-for="Dal" class="small fw-bold text-muted mb-1">Data Invio (Dal)</label>
                    <input asp-for="Dal" type="date" class="form-control form-control-sm shadow-sm" />
                </div>

                <div class="col-md-5 d-flex align-items-center gap-3">
                    <button type="submit" class="btn btn-primary btn-sm rounded-pill px-4 shadow-sm internal-link">
                        <i class="fa-solid fa-filter me-2"></i>Filtra
                    </button>
                    <a href="javascript:void(0)" id="btnToggleFilters" class="small text-decoration-none fw-bold">
                        Filtri avanzati <i class="fa-solid fa-chevron-down ms-1"></i>
                    </a>
                    <a asp-action="Index" class="small text-danger text-decoration-none border-start ps-3 internal-link">
                        Azzera filtri
                    </a>
                </div>
            </div>

            <div id="extraFilters" class="row g-3 p-3 " style="display: none;">
                <div class="col-md-3">
                    <label asp-for="FPriorità" class="small fw-bold text-muted mb-1">Priorità</label>
                    <select asp-for="FPriorità" class="form-select form-select-sm">
                        <option value="">Tutte</option>
                        <option value="Alta">Alta</option>
                        <option value="Media">Media</option>
                        <option value="Bassa">Bassa</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label asp-for="FStato" class="small fw-bold text-muted mb-1">Stato</label>
                    <select asp-for="FStato" class="form-select form-select-sm">
                        <option value="">Tutti</option>
                        <option value="Nuova - In attesa di verifica">Nuova - In attesa di verifica</option>
                        <option value="In lavorazione">In lavorazione</option>
                        <option value="Chiusa">Chiusa</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label asp-for="Fluogo" class="small fw-bold text-muted mb-1">Luogo</label>
                    <input asp-for="Fluogo" class="form-control form-control-sm" />
                </div>

                <div class="col-md-3">
                    <label asp-for="Fcategoria" class="small fw-bold text-muted mb-1">Categoria</label>
                    <select asp-for="Fcategoria" class="form-select form-select-sm">
                        <option value="">Tutte</option>
                        @foreach (var cat in (List<string>)ViewBag.Categorie)
                        {
                            <option value="@cat">@cat</option>
                        }
                    </select>
                </div>
            </div>
        </form>

     
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="fw-bold mb-0">Elenco segnalazioni</h5>

            <div id="newAlertsText" class="small fw-bold text-danger">
                Nuove da controllare: <span id="newCount">0</span>
            </div>
        </div>

       
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="toggleClosed">
            <label class="form-check-label small fw-bold text-muted" for="toggleClosed">
                Nascondi segnalazioni chiuse
            </label>
        </div>

        <div class="table-responsive border-0 shadow-sm rounded-4 bg-white">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-secondary text-uppercase" style="font-size: 0.7rem; letter-spacing: 1px;">
                    <tr>
                        <th class="border-0">Codice</th>
                        <th class="border-0">Priorità</th>
                        <th class="border-0">Stato</th>
                        <th class="border-0">Luogo</th>
                        <th class="border-0">Categoria</th>
                        <th class="border-0">Data Invio</th>
                        <th class="border-0 text-end px-4">Dettaglio</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var s in Model.Segnalazioni)
                    {
                        <tr style="transition: all 0.2s ease;">
                            <td class="px-4">
                                <span class="fw-bold text-dark">#@s.Id.ToString().Substring(0, 8).ToUpper()</span>
                            </td>
                            <td>
                                @if (s.Priorità == "Alta")
                                {
                                    <span class="badge bg-danger-subtle text-danger px-3 py-2 rounded-pill">
                                        Alta
                                    </span>
                                }
                                else if (s.Priorità == "Media")
                                {
                                    <span class="badge bg-warning-subtle text-warning-emphasis px-3 py-2 rounded-pill">
                                        Media
                                    </span>
                                }
                                else if (s.Priorità == "Non Definita")
                                {
                                    <span class="badge bg-primary-subtle text-secondary px-3 py-2 rounded-pill">
                                        In attesa di verifica
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-success-subtle text-success px-3 py-2 rounded-pill">
                                        Bassa
                                    </span>
                                }
                            </td>
                            <td>
                                @if (s.Stato == "Nuova - In attesa di verifica")
                                {
                                    <span class="badge bg-primary-subtle text-secondary px-3 py-2 rounded-pill border border-secondary-subtle">
                                        @s.Stato
                                    </span>
                                }
                                else if (s.Stato == "Chiusa")
                                {
                                    <span class="badge bg-success-subtle text-secondary px-3 py-2 rounded-pill border border-secondary-subtle">
                                        <i class="fa-solid fa-check me-1"></i>@s.Stato
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary-subtle text-secondary px-3 py-2 rounded-pill border border-secondary-subtle">
                                        <i class="fa-solid fa-clock me-1"></i> @s.Stato
                                    </span>
                                }
                            </td>
                            <td class="text-muted">@s.Luogo</td>
                            <td class="text-muted">@s.Categoria</td>
                            <td class="text-muted small">@s.DataInvio.ToString("MMM dd, HH:mm")</td>
                            <td class="text-end px-4">
                                <a asp-action="Edit" asp-route-id="@s.Id" class="btn btn-outline-primary btn-sm rounded-circle border-0 internal-link">
                                    <i class="fa-solid fa-arrow-right"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    html, body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
    }

    body {
        background: linear-gradient(180deg, #FFFFFF 0%, #ECECEC 91%);
        background-attachment: fixed;
        background-repeat: no-repeat;
    }

    .input-group-text {
        border: 1px solid #e3e3e3;
    }

    .form-control:focus {
        box-shadow: none;
        border-color: #74a2ff;
    }

    .btn-primary {
        background-color: #74a2ff;
        border-color: #74a2ff;
    }
</style>

<script>
    document.getElementById("btnToggleFilters").addEventListener("click", function () {
        const extra = document.getElementById("extraFilters");
        const isHidden = extra.style.display === "none";
        extra.style.display = isHidden ? "flex" : "none";
        this.innerHTML = isHidden ?
            'Chiudi filtri <i class="fa-solid fa-chevron-up ms-1"></i>' :
            'Filtri avanzati <i class="fa-solid fa-chevron-down ms-1"></i>';
    });

    const toggleClosed = document.getElementById("toggleClosed");

    function applyHideClosed() {
        const hideClosed = toggleClosed.checked;
        const rows = document.querySelectorAll("tbody tr");

        rows.forEach(row => {
            const stato = row.querySelector("td:nth-child(3)").innerText.trim();
            row.style.display = (hideClosed && stato === "Chiusa") ? "none" : "";
        });

        updateNewCount();
    }

    function updateNewCount() {
        const rows = document.querySelectorAll("tbody tr");
        let count = 0;

        rows.forEach(row => {
            const stato = row.querySelector("td:nth-child(3)").innerText.trim();
            if (stato === "Nuova - In attesa di verifica" && row.style.display !== "none") {
                count++;
            }
        });

        document.getElementById("newCount").innerText = count;
    }


    toggleClosed.addEventListener("change", () => {
        localStorage.setItem("hideClosedReports", toggleClosed.checked ? "true" : "false");
        applyHideClosed();
    });


       window.addEventListener("DOMContentLoaded", () => {
        const hasAdvancedFilters = @Json.Serialize(
                        !string.IsNullOrEmpty(Model.FStato) ||
                        !string.IsNullOrEmpty(Model.FPriorità) ||
                        !string.IsNullOrEmpty(Model.Fcategoria) ||
                        !string.IsNullOrEmpty(Model.Fluogo)
                );

        if (hasAdvancedFilters) {
            document.getElementById("btnToggleFilters").click();
        }

        const savedValue = localStorage.getItem("hideClosedReports");

        if (savedValue !== null) {
            toggleClosed.checked = (savedValue === "true");
        } else {
            toggleClosed.checked = false;
        }

        applyHideClosed();
    });
</script>
